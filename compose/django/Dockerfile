# ---- БАЗА ОБРАЗА ------------------------------------------------------------
# Берём официальный Python 3.12 на "slim" Debian — компактный, без лишнего.

FROM python:3.12-slim

# ---- БАЗОВЫЕ НАСТРОЙКИ PYTHON ----------------------------------------------
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1


# ---- РАБОЧАЯ ДИРЕКТОРИЯ -----------------------------------------------------
# Все дальнейшие команды и пути будут относиться к /app.
WORKDIR /app


# ---- СИСТЕМНЫЕ ЗАВИСИМОСТИ --------------------------------------------------
# build-essential  — инструменты компиляции (иногда нужны при установке пакетов).
# libpq-dev        — заголовки/библиотеки для PostgreSQL (нужны psycopg).
# Далее чистим кеш apt, чтобы образ не разрастался.
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libpq-dev && rm -rf /var/lib/apt/lists/*

# ---- PYTHON-ЗАВИСИМОСТИ -----------------------------------------------------
# Сначала копируем только requirements.txt — это оптимизирует кеш сборки:
# если зависимости не менялись, pip-слой возьмётся из кеша и сборка ускорится.
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ---- КОД ПРОЕКТА ------------------------------------------------------------
# Копируем весь репозиторий внутрь контейнера в /app.
# (Файлы, перечисленные в .dockerignore, пропускаются и не попадут в образ.)
COPY . .

# ---- ПОЛЬЗОВАТЕЛЬ БЕЗ ПРАВ root --------------------------------------------
# Безопаснее запускать приложение не от root.
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser


# ---- КАТАЛОГИ ДЛЯ СТАТИКИ/МЕДИА --------------------------------------------
# Совпадает с твоими настройками Django:  inside of the container 
# STATIC_ROOT = /app/static_collected
# MEDIA_ROOT  = /app/media
RUN mkdir -p /app/static_collected /app/media

# ---- ТОЧКА ВХОДА ------------------------------------------------------------
# Делаем скрипт запуска исполняемым…
RUN chmod +x /app/compose/django/entrypoint.sh

# …и указываем его как команду по умолчанию:
CMD ["./compose/django/entrypoint.sh"]
